
{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="resale-header">
        <h2>
            <i class="fas fa-store"></i>
            Resale System
        </h2>
        <div class="resale-search">
            <input type="text" id="resellerSearch" placeholder="Search resellers..." onkeyup="searchResellers()">
            <button onclick="searchResellers()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <!-- User View -->
    {% if user_role == 'user' %}
    <div class="resale-content">
        <div class="resale-card">
            <h3>
                <i class="fas fa-user-plus"></i>
                Become a Reseller
            </h3>
            <p>Join our reseller program and start earning commissions!</p>
            <div class="privileges">
                <h4>Reseller Privileges:</h4>
                <ul>
                    <li><i class="fas fa-dollar-sign"></i> Earn commissions on every sale</li>
                    <li><i class="fas fa-chart-line"></i> Track your sales and earnings</li>
                    <li><i class="fas fa-link"></i> Create custom referral links</li>
                    <li><i class="fas fa-users"></i> Build your own customer base</li>
                </ul>
            </div>
            <div class="guidelines">
                <h4>Guidelines:</h4>
                <ul>
                    <li>Maintain professional communication</li>
                    <li>Provide accurate product information</li>
                    <li>Support your referred customers</li>
                    <li>Follow platform terms of service</li>
                </ul>
            </div>
            <button onclick="showResellerRequestModal()" class="resale-btn">
                <i class="fas fa-hand-paper"></i>
                Request Reseller Access
            </button>
        </div>

        <div class="best-resellers">
            <h3>
                <i class="fas fa-star"></i>
                Top Resellers
            </h3>
            <div id="bestResellersList"></div>
        </div>

        <div class="reseller-list">
            <h3>
                <i class="fas fa-users"></i>
                All Resellers
            </h3>
            <div id="resellersList"></div>
        </div>

        <div class="pricing-tiers">
            <h3>
                <i class="fas fa-tags"></i>
                Subscription Tiers
            </h3>
            <div class="pricing-grid">
                {% for tier_name, prices in pricelist.items() %}
                <div class="tier-card {{ tier_name }}">
                    <h4>{{ tier_name.title() }} Edition</h4>
                    {% for duration, price_info in prices.items() %}
                    <div class="price-row">
                        <span>{{ duration }} days</span>
                        <div class="price-comparison">
                            <div class="price-item">
                                <small>For Users</small>
                                <span class="price">${{ "%.2f"|format(price_info.user_price) }}</span>
                            </div>
                            <div class="price-item">
                                <small>For Resellers</small>
                                <span class="price discounted">${{ "%.2f"|format(price_info.user_price * 0.67) }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Reseller View -->
    {% if user_role == 'reseller' %}
    <div class="reseller-dashboard">
        <div class="dashboard-stats">
            <h3>
                <i class="fas fa-chart-bar"></i>
                Dashboard
            </h3>
            <div id="resellerStats" class="stats-grid"></div>
        </div>

        <div class="referral-management">
            <h3>
                <i class="fas fa-code"></i>
                Referral Codes
            </h3>
            <button onclick="showCreateReferralModal()" class="resale-btn">
                <i class="fas fa-plus"></i>
                Create New Code
            </button>
            <div id="referralCodes" class="codes-list"></div>
        </div>

        <div class="referred-users">
            <h3>
                <i class="fas fa-users"></i>
                Referred Users
            </h3>
            <div id="referredUsers" class="users-list"></div>
        </div>
    </div>
    {% endif %}

    <!-- Admin View (only for admin) -->
    {% if user_role == 'admin' %}
    <div class="admin-resale-panel">
        <div class="resale-tabs">
            <button class="resale-tab active" onclick="switchResaleTab('requests')">
                <i class="fas fa-user-check"></i>
                Reseller Requests
            </button>
            <button class="resale-tab" onclick="switchResaleTab('management')">
                <i class="fas fa-users-cog"></i>
                Manage Resellers
            </button>
            <button class="resale-tab" onclick="switchResaleTab('sales')">
                <i class="fas fa-chart-line"></i>
                Sales & Payouts
            </button>
        </div>

        <div id="resale-requests" class="resale-content active">
            <div id="resellerRequests"></div>
        </div>

        <div id="resale-management" class="resale-content">
            <div id="resellerManagement"></div>
        </div>

        <div id="resale-sales" class="resale-content">
            <div id="salesData"></div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modals -->
<div id="resellerRequestModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-user-plus"></i>
            Request Reseller Access
        </h3>
        <div class="form-group">
            <label>Why do you want to become a reseller?</label>
            <textarea id="resellerMessage" rows="4" placeholder="Tell us about your motivation and experience..."></textarea>
        </div>
        <div class="modal-actions">
            <button onclick="submitResellerRequest()">
                <i class="fas fa-paper-plane"></i>
                Submit Request
            </button>
            <button onclick="closeModal('resellerRequestModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="createReferralModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-code"></i>
            Create Referral Code
        </h3>
        <div class="form-group">
            <label>Code Name:</label>
            <input type="text" id="newReferralCode" placeholder="Enter referral code...">
        </div>
        <div class="form-group">
            <label>Target Tier:</label>
            <select id="newReferralTier">
                <option value="Silver Edition">Silver Edition</option>
                <option value="Gold Edition">Gold Edition</option>
                <option value="Elite Edition">Elite Edition</option>
            </select>
        </div>
        <div class="form-group">
            <label>Usage Limit:</label>
            <input type="number" id="newReferralLimit" value="100" min="1">
        </div>
        <div class="form-group">
            <label>Commission Rate (%):</label>
            <input type="number" id="newCommissionRate" value="10" min="1" max="50">
        </div>
        <div class="modal-actions">
            <button onclick="createReferralCode()">
                <i class="fas fa-plus"></i>
                Create Code
            </button>
            <button onclick="closeModal('createReferralModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="chatModal" class="modal">
    <div class="modal-content chat-modal">
        <div class="chat-header">
            <h3 id="chatModalTitle">
                <i class="fas fa-comments"></i>
                Chat
            </h3>
            <button onclick="closeModal('chatModal')" class="chat-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="chatMessageInput" placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
            <button onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Include all resale system JavaScript functions from the main template
let currentChatRecipient = '';

function loadResaleData() {
    fetch('/api/resale/resellers')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResellers(data.resellers);
            displayBestResellers(data.resellers);
        }
    });

    const username = '{{ session.get("username", "") }}';
    if ('{{ user_role }}' === 'reseller') {
        fetch(`/api/resale/dashboard/${username}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResellerDashboard(data.dashboard);
            }
        });
    }
}

function displayResellers(resellers) {
    const container = document.getElementById('resellersList');
    if (!container) return;

    container.innerHTML = resellers.map(reseller => `
        <div class="reseller-item">
            <div class="reseller-info">
                <h4>${reseller.username}</h4>
                <div class="reseller-stats">
                    <span class="stat">‚≠ê ${reseller.rating || '5.0'}</span>
                    <span class="stat">üí∞ ${reseller.sales || '0'} sales</span>
                    <span class="stat">üèÜ ${reseller.rank || 'New'}</span>
                </div>
                <div class="platforms">
                    ${reseller.platforms.map(platform => 
                        `<i class="fab fa-${platform}" title="${platform}" onclick="openSocialMedia('${reseller.username}', '${platform}')"></i>`
                    ).join('')}
                </div>
            </div>
            <div class="reseller-actions">
                <button onclick="openChat('${reseller.username}')" class="btn-secondary">
                    <i class="fas fa-comments"></i>
                    Message
                </button>
                <button onclick="viewResellerProfile('${reseller.username}')" class="btn-secondary">
                    <i class="fas fa-user"></i>
                    Profile
                </button>
            </div>
        </div>
    `).join('');
}

function displayBestResellers(resellers) {
    const container = document.getElementById('bestResellersList');
    if (!container) return;

    // Sort by rating and sales
    const topResellers = resellers
        .sort((a, b) => (b.rating || 0) - (a.rating || 0))
        .slice(0, 3);

    container.innerHTML = topResellers.map((reseller, index) => `
        <div class="best-reseller-item">
            <div class="rank-badge">#${index + 1}</div>
            <div class="reseller-info">
                <h4>${reseller.username}</h4>
                <div class="rating">‚≠ê ${reseller.rating || '5.0'}</div>
                <div class="sales">${reseller.sales || '0'} sales</div>
            </div>
            <button onclick="openChat('${reseller.username}')" class="btn-secondary">
                <i class="fas fa-comments"></i>
                Chat
            </button>
        </div>
    `).join('');
}

function searchResellers() {
    const searchTerm = document.getElementById('resellerSearch').value.toLowerCase();
    const resellerItems = document.querySelectorAll('.reseller-item');
    
    resellerItems.forEach(item => {
        const username = item.querySelector('h4').textContent.toLowerCase();
        const platforms = item.querySelector('.platforms').textContent.toLowerCase();
        
        if (username.includes(searchTerm) || platforms.includes(searchTerm) || searchTerm === '') {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Also filter best resellers
    const bestResellerItems = document.querySelectorAll('.best-reseller-item');
    bestResellerItems.forEach(item => {
        const username = item.querySelector('h4').textContent.toLowerCase();
        
        if (username.includes(searchTerm) || searchTerm === '') {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function openSocialMedia(username, platform) {
    // This would open the reseller's social media profile
    alert(`Opening ${platform} profile for ${username}`);
}

function viewResellerProfile(username) {
    // This would show detailed reseller profile
    alert(`Viewing profile for ${username}`);
}

function displayResellerDashboard(dashboard) {
    const statsContainer = document.getElementById('resellerStats');
    if (statsContainer) {
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${dashboard.stats.users_referred}</div>
                <div class="stat-label">Users Referred</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">$${dashboard.stats.earnings.pending.toFixed(2)}</div>
                <div class="stat-label">Pending Earnings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${dashboard.stats.commission_rate}%</div>
                <div class="stat-label">Commission Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${dashboard.stats.credits}</div>
                <div class="stat-label">Credits</div>
            </div>
        `;
    }

    const codesContainer = document.getElementById('referralCodes');
    if (codesContainer) {
        codesContainer.innerHTML = dashboard.referral_codes.map(code => `
            <div class="code-item">
                <div class="code-info">
                    <strong>${code.code}</strong>
                    <span>${code.used}/${code.limit} used</span>
                    <span>${code.tier}</span>
                </div>
                <div class="code-actions">
                    <button onclick="copyToClipboard('${code.code}')" class="btn-secondary">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                </div>
            </div>
        `).join('');
    }
}

function showResellerRequestModal() {
    showModal('resellerRequestModal');
}

function submitResellerRequest() {
    const message = document.getElementById('resellerMessage').value.trim();

    if (!message) {
        alert('Please provide a message');
        return;
    }

    fetch('/api/resale/request_reseller', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeModal('resellerRequestModal');
        } else {
            alert(data.error);
        }
    });
}

function showCreateReferralModal() {
    showModal('createReferralModal');
}

function createReferralCode() {
    const code = document.getElementById('newReferralCode').value.trim();
    const tier = document.getElementById('newReferralTier').value;
    const limit = parseInt(document.getElementById('newReferralLimit').value);
    const commissionRate = parseInt(document.getElementById('newCommissionRate').value);

    if (!code) {
        alert('Please enter a referral code');
        return;
    }

    fetch('/api/resale/create_referral', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            code: code,
            tier: tier,
            limit: limit,
            commission_rate: commissionRate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeModal('createReferralModal');
            loadResaleData();
        } else {
            alert(data.error);
        }
    });
}

function openChat(recipient) {
    currentChatRecipient = recipient;
    document.getElementById('chatModalTitle').innerHTML = `<i class="fas fa-comments"></i> Chat with ${recipient}`;
    loadChatMessages(recipient);
    showModal('chatModal');
}

function loadChatMessages(recipient) {
    fetch(`/api/resale/chat/get/${recipient}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayChatMessages(data.messages);
        }
    });
}

function displayChatMessages(messages) {
    const container = document.getElementById('chatMessages');
    const currentUser = '{{ session.get("username", "") }}';

    container.innerHTML = messages.map(msg => `
        <div class="chat-message ${msg.sender === currentUser ? 'own' : 'other'}">
            <div class="message-bubble ${msg.sender === currentUser ? 'own' : 'other'}">
                ${msg.message}
                <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            </div>
        </div>
    `).join('');

    container.scrollTop = container.scrollHeight;
}

function handleChatKeypress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function sendChatMessage() {
    const input = document.getElementById('chatMessageInput');
    const message = input.value.trim();

    if (!message) return;

    fetch('/api/resale/chat/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            recipient: currentChatRecipient,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadChatMessages(currentChatRecipient);
        }
    });
}

function switchResaleTab(tab) {
    const tabs = document.querySelectorAll('.resale-tab');
    const contents = document.querySelectorAll('.resale-content');

    tabs.forEach(t => t.classList.remove('active'));
    contents.forEach(c => c.classList.remove('active'));

    document.querySelector(`[onclick="switchResaleTab('${tab}')"]`).classList.add('active');
    document.getElementById('resale-' + tab).classList.add('active');
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadResaleData();
});
</script>

<style>
/* Include all resale-specific styles from the main template */
.resale-header {
    text-align: center;
    margin-bottom: 32px;
}

.resale-header h2 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.resale-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 32px;
}

.resale-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-card);
}

.resale-card h3 {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-primary);
    margin-bottom: 16px;
}

.privileges ul, .guidelines ul {
    list-style: none;
    padding: 0;
}

.privileges li, .guidelines li {
    padding: 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--fg-secondary);
}

.privileges i {
    color: var(--accent-primary);
    width: 16px;
}

.resale-btn {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
}

.resale-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-neon);
}

.pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.tier-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.tier-card h4 {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-primary);
    margin-bottom: 16px;
}

.price-row {
    margin-bottom: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-primary);
}

.price-row span:first-child {
    font-weight: 600;
    color: var(--fg-primary);
    display: block;
    margin-bottom: 8px;
}

.price-comparison {
    display: flex;
    justify-content: space-between;
    gap: 16px;
}

.price-item {
    text-align: center;
    flex: 1;
}

.price-item small {
    display: block;
    font-size: 10px;
    color: var(--fg-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.price {
    font-weight: 600;
    color: var(--accent-secondary);
    font-size: 16px;
    display: block;
}

.price.discounted {
    color: var(--accent-primary);
    position: relative;
}

.price.discounted::after {
    content: '33% OFF';
    position: absolute;
    top: -16px;
    right: 0;
    font-size: 8px;
    background: var(--accent-primary);
    color: var(--bg-primary);
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
}

.resale-tabs {
    display: flex;
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 24px;
}

.resale-tab {
    flex: 1;
    background: none;
    border: none;
    padding: 16px 20px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
    color: var(--fg-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.resale-tab.active {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    box-shadow: var(--shadow-neon);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: var(--accent-primary);
    font-family: 'JetBrains Mono', monospace;
}

.chat-modal {
    width: 90%;
    max-width: 600px;
    height: 70vh;
    display: flex;
    flex-direction: column;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: 16px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.chat-message {
    display: flex;
    gap: 12px;
    margin-bottom: 8px;
}

.chat-message.own {
    justify-content: flex-end;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
}

.message-bubble.own {
    background: var(--gradient-primary);
    color: var(--bg-primary);
}

.message-bubble.other {
    background: var(--bg-secondary);
    color: var(--fg-primary);
}

.chat-input {
    display: flex;
    gap: 12px;
    padding-top: 16px;
    border-top: 1px solid var(--border-primary);
}

.chat-input input {
    flex: 1;
}

/* Search Styles */
.resale-search {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.resale-search input {
    flex: 1;
}

/* Best Resellers */
.best-resellers {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-card);
    margin-bottom: 24px;
}

.best-reseller-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 12px;
}

.rank-badge {
    width: 40px;
    height: 40px;
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 18px;
}

/* Enhanced Reseller Items */
.reseller-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
}

.reseller-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-card);
}

.reseller-stats {
    display: flex;
    gap: 12px;
    margin: 8px 0;
    font-size: 14px;
}

.stat {
    background: var(--bg-tertiary);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
}

.platforms i {
    cursor: pointer;
    margin-right: 8px;
    font-size: 18px;
    transition: all 0.3s ease;
}

.platforms i:hover {
    transform: scale(1.2);
    color: var(--accent-primary);
}

.reseller-actions {
    display: flex;
    gap: 8px;
}

.rating {
    color: #ffd700;
    font-weight: 600;
}

.sales {
    color: var(--accent-primary);
    font-size: 14px;
}

@media (max-width: 768px) {
    .resale-content {
        grid-template-columns: 1fr;
    }

    .pricing-grid {
        grid-template-columns: 1fr;
    }

    .resale-tabs {
        flex-direction: column;
    }

    .reseller-item {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }

    .reseller-actions {
        justify-content: center;
    }

    .best-reseller-item {
        flex-direction: column;
        text-align: center;
    }

    .resale-search {
        margin: 16px 0;
    }
}
</style>
{% endblock %}
