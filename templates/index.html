{% extends "base.html" %}

{% block content %}
<!-- Menu Toggle -->
<button class="menu-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar -->
<div class="sidebar-overlay" onclick="closeSidebar()"></div>
<div class="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-title">
            <i class="fas fa-cog"></i>
            Control Panel
        </span>
        <button class="sidebar-close" onclick="closeSidebar()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <nav>
        <ul class="sidebar-nav">
            <li><a href="#" class="active">
                <i class="fas fa-database"></i>
                Firebase Editor
            </a></li>
            <li><a href="/resale">
                <i class="fas fa-store"></i>
                Resale System
            </a></li>
            <li><a href="/profile">
                <i class="fas fa-user-circle"></i>
                Profile
            </a></li>
            {% if tier == 'Elite Edition' and session.get('is_admin') %}
            <li><a href="/admin">
                <i class="fas fa-crown"></i>
                Admin Panel
            </a></li>
            {% endif %}
            <li><a href="/settings">
                <i class="fas fa-cog"></i>
                Settings
            </a></li>
        </ul>
    </nav>

    <div class="theme-selector">
        <h4>
            <i class="fas fa-palette"></i>
            Themes
        </h4>
        <div class="theme-grid">
            <div class="theme-option active" data-theme="default">Neon Green</div>
            <div class="theme-option" data-theme="cyberpunk">Cyberpunk</div>
            <div class="theme-option" data-theme="matrix">Matrix</div>
            <div class="theme-option" data-theme="purple">Purple Haze</div>
            <div class="theme-option" data-theme="sunset">Sunset</div>
        </div>
    </div>
</div>

<div class="content-wrapper">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="edition-label">{{ tier }}</div>

            <div class="url-section">
                <label>
                    <i class="fas fa-database"></i>
                    Firebase RTDB URL:
                </label>
                {% if tier == 'Elite Edition' %}
                <select id="urlProfile" style="width: 180px;">
                    <option value="">Select Profile</option>
                    {% for profile in url_profiles %}
                    <option value="{{ profile }}">{{ profile }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                <input type="text" id="firebaseUrl" placeholder="https://your-project-id-default-rtdb.firebaseio.com" style="flex: 1; min-width: 250px;">
            </div>

            <div class="header-buttons">
                {% if tier == 'Elite Edition' %}
                <button onclick="showAddUrlModal()">
                    <i class="fas fa-plus"></i>
                    Add URL
                </button>
                <button onclick="removeUrlProfile()">
                    <i class="fas fa-trash"></i>
                    Remove
                </button>
                {% endif %}
                <button onclick="fetchData()" id="fetchBtn">
                    <i class="fas fa-download"></i>
                    Fetch
                </button>
                <button onclick="logout()" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="status info">
            <i class="fas fa-info-circle"></i>
            Ready to connect to Firebase
        </div>

        <!-- Path Navigator -->
        <div class="path-navigator">
            <label>
                <i class="fas fa-map-marker-alt"></i>
                Navigate to Path:
            </label>
            <input type="text" id="pathNavigator" placeholder="Enter path (e.g., users/user1/name)" 
                   onkeypress="handlePathNavigation(event)">
            <button onclick="navigateToPath()">
                <i class="fas fa-arrow-right"></i>
                Go
            </button>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <label>
                <i class="fas fa-search"></i>
                Search:
            </label>
            <input type="text" id="searchTerm" placeholder="Enter search term..." style="width: 250px;">
            <button onclick="searchData()">
                <i class="fas fa-search"></i>
                Find
            </button>

            {% if tier == 'Elite Edition' and has_validate %}
            <div style="margin-left: auto; display: flex; gap: 8px;">
                <button onclick="loadSchema()">
                    <i class="fas fa-file-code"></i>
                    Schema
                </button>
                <button onclick="validateSchema()" {% if not has_schema %}disabled{% endif %}>
                    <i class="fas fa-check-circle"></i>
                    Validate
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Main Content - Side by Side Layout -->
        <div class="main-content">
            <!-- Tree Panel -->
            <div class="tree-panel">
                <h3>
                    <i class="fas fa-sitemap"></i>
                    Data Tree
                </h3>
                <div class="tree-controls">
                    <button onclick="expandAll()" class="btn-secondary">
                        <i class="fas fa-expand-arrows-alt"></i>
                        Expand
                    </button>
                    <button onclick="collapseAll()" class="btn-secondary">
                        <i class="fas fa-compress-arrows-alt"></i>
                        Collapse
                    </button>
                </div>
                <div id="treeView"></div>
            </div>

            <!-- Editor Panel -->
            <div class="editor-panel">
                <h3>
                    <i class="fas fa-code"></i>
                    Code Editor
                </h3>
                <div class="form-group">
                    <label>
                        <i class="fas fa-map-marker-alt"></i>
                        Selected Path:
                    </label>
                    <div id="selectedPath"></div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>
                        <i class="fas fa-brackets-curly"></i>
                        JSON Value:
                    </label>
                    <textarea id="nodeValue" placeholder="Select a node to edit its value..." rows="15"></textarea>
                </div>

                {% if tier in ['Gold Edition', 'Elite Edition'] %}
                <div class="node-actions">
                    <button onclick="updateNode()" id="updateBtn" disabled>
                        <i class="fas fa-save"></i>
                        Update
                    </button>
                    <button onclick="showAddChildModal()" id="addChildBtn" disabled>
                        <i class="fas fa-plus"></i>
                        Add Child
                    </button>
                    <button onclick="deleteNode()" id="deleteBtn" disabled>
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                    <button onclick="showDuplicateModal()" id="duplicateBtn" disabled>
                        <i class="fas fa-copy"></i>
                        Duplicate
                    </button>
                    {% if tier == 'Elite Edition' %}
                    <button onclick="showPushItemModal()" id="pushBtn" disabled>
                        <i class="fas fa-upload"></i>
                        Push
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Bottom Actions -->
        <div class="bottom-actions">
            {% if tier == 'Elite Edition' %}
            <button onclick="saveData()">
                <i class="fas fa-download"></i>
                Save
            </button>
            <button onclick="loadDataFromFile()">
                <i class="fas fa-upload"></i>
                Load
            </button>
            <button onclick="exportData()">
                <i class="fas fa-file-export"></i>
                Export
            </button>
            {% endif %}
            {% if tier in ['Gold Edition', 'Elite Edition'] %}
            <button onclick="applyChanges()" id="applyBtn" disabled>
                <i class="fas fa-cloud-upload-alt"></i>
                Apply Changes
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Notifications Modal -->
<div id="notificationsModal" class="modal">
    <div class="modal-content notifications-modal">
        <div class="modal-header">
            <h3>
                <i class="fas fa-bell"></i>
                Notifications
            </h3>
            <button onclick="closeModal('notificationsModal')" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-content">
            <div class="notifications-actions">
                <button onclick="markAllNotificationsRead()" class="btn-secondary">
                    <i class="fas fa-check"></i>
                    Mark All Read
                </button>
                <button onclick="clearAllNotifications()" class="btn-secondary">
                    <i class="fas fa-trash"></i>
                    Clear All
                </button>
            </div>
            <div id="notificationsList" class="notifications-list modal-content-scrollable"></div>
        </div>
    </div>
</div>

<!-- Messages Modal -->
<div id="messagesModal" class="modal">
    <div class="modal-content messages-modal">
        <div class="modal-header">
            <h3>
                <i class="fas fa-envelope"></i>
                Messages
            </h3>
            <button onclick="closeModal('messagesModal')" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="messages-content">
            <div id="messagesList" class="messages-list modal-content-scrollable"></div>
        </div>
    </div>
</div></div>

<!-- Individual Chat Modal -->
<div id="individualChatModal" class="modal">
    <div class="modal-content chat-modal">
        <div class="chat-header">
            <h3 id="individualChatTitle">
                <i class="fas fa-comments"></i>
                Chat
            </h3>
            <button onclick="closeModal('individualChatModal')" class="chat-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="individualChatMessages"></div>
        <div class="chat-input">
            <input type="text" id="individualChatInput" placeholder="Type your message..." onkeypress="handleIndividualChatKeypress(event)">
            <button onclick="sendIndividualChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<div id="createReferralModal" class="modal"></div>

<div id="customDialog" class="modal">
    <div class="modal-content custom-dialog">
        <div class="dialog-header">
            <h3 id="dialogTitle">Confirm</h3>
        </div>
        <div class="dialog-content">
            <p id="dialogMessage">Are you sure?</p>
        </div>
        <div class="dialog-actions">
            <button id="dialogConfirm" onclick="handleDialogConfirm()">Confirm</button>
            <button id="dialogCancel" onclick="closeModal('customDialog')" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<div id="customAlert" class="modal">
    <div class="modal-content custom-alert">
        <div class="alert-header">
            <h3 id="alertTitle">Notice</h3>
        </div>
        <div class="alert-content">
            <p id="alertMessage">Message</p>
        </div>
        <div class="alert-actions">
            <button onclick="closeModal('customAlert')">OK</button>
        </div>
    </div>
</div>

<div id="createReferralModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-code"></i>
            Create Referral Code
        </h3>
        <div class="form-group">
            <label>Code Name:</label>
            <input type="text" id="newReferralCode" placeholder="Enter referral code...">
        </div>
        <div class="form-group">
            <label>Target Tier:</label>
            <select id="newReferralTier">
                <option value="Silver Edition">Silver Edition</option>
                <option value="Gold Edition">Gold Edition</option>
                <option value="Elite Edition">Elite Edition</option>
            </select>
        </div>
        <div class="form-group">
            <label>Usage Limit:</label>
            <input type="number" id="newReferralLimit" value="100" min="1">
        </div>
        <div class="form-group">
            <label>Commission Rate (%):</label>
            <input type="number" id="newCommissionRate" value="10" min="1" max="50">
        </div>
        <div class="modal-actions">
            <button onclick="createReferralCode()">
                <i class="fas fa-plus"></i>
                Create Code
            </button>
            <button onclick="closeModal('createReferralModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="chatModal" class="modal">
    <div class="modal-content chat-modal">
        <div class="chat-header">
            <h3 id="chatModalTitle">
                <i class="fas fa-comments"></i>
                Chat
            </h3>
            <button onclick="closeModal('chatModal')" class="chat-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="chatMessageInput" placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
            <button onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- All existing modals remain... -->
<div id="addChildModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-plus-circle"></i>
            Add Child Node
        </h3>
        <div class="form-group">
            <label>Key (for objects only):</label>
            <input type="text" id="childKey" placeholder="Enter key name...">
        </div>
        <div class="form-group">
            <label>Value (JSON format):</label>
            <textarea id="childValue" rows="5" placeholder='{"example": "value"}'></textarea>
        </div>
        <div class="modal-actions">
            <button onclick="addChild()">
                <i class="fas fa-plus"></i>
                Add
            </button>
            <button onclick="closeModal('addChildModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="duplicateModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-copy"></i>
            Duplicate Node
        </h3>
        <div class="form-group">
            <label>New Key:</label>
            <input type="text" id="duplicateKey" placeholder="Enter new key name...">
        </div>
        <div class="modal-actions">
            <button onclick="duplicateNode()">
                <i class="fas fa-copy"></i>
                Duplicate
            </button>
            <button onclick="closeModal('duplicateModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="pushItemModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-upload"></i>
            Push New Item
        </h3>
        <div class="form-group">
            <label>Item Content (JSON format):</label>
            <textarea id="pushContent" rows="5" placeholder='{"field": "value"}'></textarea>
        </div>
        <div class="modal-actions">
            <button onclick="pushItem()">
                <i class="fas fa-upload"></i>
                Push
            </button>
            <button onclick="closeModal('pushItemModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="addUrlModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-plus-circle"></i>
            Add URL Profile
        </h3>
        <div class="form-group">
            <label>Profile Name:</label>
            <input type="text" id="urlName" placeholder="Enter profile name...">
        </div>
        <div class="form-group">
            <label>Firebase URL:</label>
            <input type="text" id="urlValue" placeholder="https://your-project-default-rtdb.firebaseio.com">
        </div>
        <div class="modal-actions">
            <button onclick="addUrlProfile()">
                <i class="fas fa-plus"></i>
                Add
            </button>
            <button onclick="closeModal('addUrlModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="exportModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-file-export"></i>
            Export Data
        </h3>
        <div class="form-group">
            <label>Export Format:</label>
            <select id="exportFormat">
                <option value="json">JSON</option>
                <option value="csv">CSV</option>
            </select>
        </div>
        <div class="modal-actions">
            <button onclick="performExport()">
                <i class="fas fa-download"></i>
                Export
            </button>
            <button onclick="closeModal('exportModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- New Modals for Admin -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-user-plus"></i>
            Add New User
        </h3>
        <div class="form-group">
            <label>Username:</label>
            <input type="text" id="newUsername" placeholder="Enter username...">
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="newPassword" placeholder="Enter password...">
        </div>
        <div class="form-group">
            <label>Tier:</label>
            <select id="newUserTier">
                <option value="Silver Edition">Silver Edition</option>
                <option value="Gold Edition">Gold Edition</option>
                <option value="Elite Edition">Elite Edition</option>
            </select>
        </div>
        <div class="modal-actions">
            <button onclick="addUser()">
                <i class="fas fa-plus"></i>
                Add User
            </button>
            <button onclick="closeModal('addUserModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="createReferralModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-gift"></i>
            Create Referral Code
        </h3>
        <div class="form-group">
            <label>Code Name:</label>
            <input type="text" id="referralName" placeholder="Enter referral name...">
        </div>
        <div class="form-group">
            <label>Uses Limit:</label>
            <input type="number" id="referralLimit" placeholder="Enter usage limit..." value="100">
        </div>
        <div class="form-group">
            <label>Target Tier:</label>
            <select id="referralTier">
                <option value="Silver Edition">Silver Edition</option>
                <option value="Gold Edition">Gold Edition</option>
                <option value="Elite Edition">Elite Edition</option>
            </select>
        </div>
        <div class="modal-actions">
            <button onclick="createReferral()">
                <i class="fas fa-plus"></i>
                Create
            </button>
            <button onclick="closeModal('createReferralModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">
<input type="file" id="schemaInput" accept=".json" style="display: none;" onchange="handleSchemaLoad(event)">

<style>
/* Additional styles for resale system */
.resale-header {
    text-align: center;
    margin-bottom: 32px;
}

.resale-header h2 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.resale-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 32px;
}

.resale-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-card);
}

.resale-card h3 {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-primary);
    margin-bottom: 16px;
}

.privileges ul, .guidelines ul {
    list-style: none;
    padding: 0;
}

.privileges li, .guidelines li {
    padding: 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--fg-secondary);
}

.privileges i {
    color: var(--accent-primary);
    width: 16px;
}

.resale-btn {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
}

.resale-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-neon);
}

.pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.tier-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.tier-card h4 {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-primary);
    margin-bottom: 16px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-primary);
}

.price {
    font-weight: 600;
    color: var(--accent-secondary);
}

.resale-tabs {
    display: flex;
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 24px;
}

.resale-tab {
    flex: 1;
    background: none;
    border: none;
    padding: 16px 20px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
    color: var(--fg-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.resale-tab.active {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    box-shadow: var(--shadow-neon);
}

.resale-content {
    display: none;
}

.resale-content.active {
    display: block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: var(--accent-primary);
    font-family: 'JetBrains Mono', monospace;
}

.chat-modal {
    width: 90%;
    max-width: 600px;
    height: 70vh;
    display: flex;
    flex-direction: column;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: 16px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.chat-message {
    display: flex;
    gap: 12px;
    margin-bottom: 8px;
}

.chat-message.own {
    justify-content: flex-end;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
}

.message-bubble.own {
    background: var(--gradient-primary);
    color: var(--bg-primary);
}

.message-bubble.other {
    background: var(--bg-secondary);
    color: var(--fg-primary);
}

.chat-input {
    display: flex;
    gap: 12px;
    padding-top: 16px;
    border-top: 1px solid var(--border-primary);
}

.chat-input input {
    flex: 1;
}

.settings-actions {
    margin-top: 32px;
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
}

.apply-settings-btn {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border: none;
    padding: 16px 32px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.apply-settings-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-neon);
}

/* Fixed tree expansion issues */
.tree-toggle {
    width: 0;
    height: 0;
    border-left: 8px solid var(--accent-primary);
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-right: 8px;
    filter: drop-shadow(0 0 4px var(--accent-primary));
}

.tree-toggle:hover {
    filter: drop-shadow(0 0 8px var(--accent-primary));
    transform: scale(1.1);
}

.tree-toggle.expanded {
    transform: rotate(90deg);
}

.tree-toggle.collapsed {
    transform: rotate(0deg);
}

.tree-children {
    margin-left: 16px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.tree-children.collapsed {
    max-height: 0;
    opacity: 0;
}

.tree-children.expanded {
    max-height: 1000px;
    opacity: 1;
}

/* Styles for Notifications Modal */
.notifications-modal {
    width: 90%;
    max-width: 500px;
}

.notifications-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-primary);
    padding-bottom: 16px;
    margin-bottom: 16px;
}

.notifications-actions {
    display: flex;
    justify-content: space-between;
    margin-bottom: 24px;
}

.notifications-list {
    max-height: 400px;
    overflow-y: auto;
}

.notification-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--fg-primary);
}

.notification-item.unread {
    background: var(--glass-bg);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.notification-time {
    font-size: 0.8em;
    color: var(--fg-secondary);
}

/* Styles for Custom Dialog */
.custom-dialog {
    width: 90%;
    max-width: 400px;
}

.custom-dialog .dialog-header {
    border-bottom: 1px solid var(--border-primary);
    padding-bottom: 16px;
    margin-bottom: 16px;
}

.custom-dialog .dialog-content {
    margin-bottom: 24px;
    color: var(--fg-primary);
    font-family: 'JetBrains Mono', monospace;
}

.custom-dialog .dialog-actions {
    display: flex;
    justify-content: flex-end;
    gap: 16px;
}

/* Styles for Custom Alert */
.custom-alert {
    width: 90%;
    max-width: 400px;
}

.custom-alert .alert-header {
    border-bottom: 1px solid var(--border-primary);
    padding-bottom: 16px;
    margin-bottom: 16px;
}

.custom-alert .alert-content {
    margin-bottom: 24px;
    color: var(--fg-primary);
    font-family: 'JetBrains Mono', monospace;
}

.custom-alert .alert-actions {
    display: flex;
    justify-content: flex-end;
}

@media (max-width: 768px) {
    .resale-content {
        grid-template-columns: 1fr;
    }

    .pricing-grid {
        grid-template-columns: 1fr;
    }

    .resale-tabs {
        flex-direction: column;
    }

    .settings-actions {
        flex-direction: column;
    }
}
</style>

<script>
let currentData = {{ tree_data | tojson | safe }};
let selectedPath = '';
let searchResults = [];
let currentSearchIndex = 0;
let expandedNodes = new Set();
let currentView = 'app';
let currentChatRecipient = '';

// Enhanced tree functions with better expansion/collapse
function renderTree(data, container = null, indent = 0, parentPath = '') {
    if (!container) {
        container = document.getElementById('treeView');
        container.innerHTML = '';
    }

    data.forEach(node => {
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'tree-node-wrapper';

        const nodeElement = document.createElement('div');
        nodeElement.className = `tree-node ${node.type}`;
        nodeElement.style.paddingLeft = `${indent * 20}px`;
        nodeElement.onclick = (e) => {
            e.stopPropagation();
            selectNode(node.path, node.key);
        };

        const nodeContent = document.createElement('div');
        nodeContent.className = 'tree-node-content';
        nodeContent.style.display = 'flex';
        nodeContent.style.alignItems = 'center';

        if (node.type === 'container' && node.children && node.children.length > 0) {
            const toggle = document.createElement('div');
            toggle.className = expandedNodes.has(node.path) ? 'tree-toggle expanded' : 'tree-toggle collapsed';
            toggle.onclick = (e) => {
                e.stopPropagation();
                toggleNode(node.path, toggle, nodeDiv);
            };
            nodeContent.appendChild(toggle);
        } else {
            const spacer = document.createElement('div');
            spacer.style.width = '16px';
            nodeContent.appendChild(spacer);
        }

                const icon = document.createElement('i');
        icon.className = node.type === 'container' ? 'fas fa-folder tree-icon' : 'fas fa-key tree-icon';
        icon.style.marginRight = '8px';
        icon.style.color = 'var(--accent-secondary)';
        nodeContent.appendChild(icon);

        const keySpan = document.createElement('span');
        keySpan.className = 'key';
        keySpan.textContent = node.key;
        nodeContent.appendChild(keySpan);

        if (node.value) {
            const valueSpan = document.createElement('span');
            valueSpan.className = 'value';
            valueSpan.textContent = `: ${node.value.length > 50 ? node.value.substring(0, 50) + '...' : node.value}`;
            nodeContent.appendChild(valueSpan);
        }

        nodeElement.appendChild(nodeContent);
        nodeDiv.appendChild(nodeElement);

        if (node.children && node.children.length > 0) {
            const childrenDiv = document.createElement('div');
            childrenDiv.className = expandedNodes.has(node.path) ? 'tree-children expanded' : 'tree-children collapsed';
            renderTree(node.children, childrenDiv, indent + 1, node.path);
            nodeDiv.appendChild(childrenDiv);
        }

        container.appendChild(nodeDiv);
    });
}

function toggleNode(path, toggle, nodeWrapper) {
    const childrenDiv = nodeWrapper.querySelector('.tree-children');
    if (!childrenDiv) return;

    if (expandedNodes.has(path)) {
        expandedNodes.delete(path);
        toggle.className = 'tree-toggle collapsed';
        childrenDiv.className = 'tree-children collapsed';
    } else {
        expandedNodes.add(path);
        toggle.className = 'tree-toggle expanded';
        childrenDiv.className = 'tree-children expanded';
    }
}

function selectNode(path, key) {
    selectedPath = path;

    document.querySelectorAll('.tree-node').forEach(node => {
        node.classList.remove('selected');
    });
    event.target.closest('.tree-node').classList.add('selected');

    document.getElementById('selectedPath').innerHTML = `<i class="fas fa-map-marker-alt"></i> /${path}`;
    document.getElementById('pathNavigator').value = path;

    fetch('/api/get_node_value', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({path: path})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('nodeValue').value = data.value;
            enableNodeActions(true);
        }
    });
}

function enableNodeActions(enable) {
    const buttons = ['updateBtn', 'addChildBtn', 'deleteBtn', 'duplicateBtn', 'pushBtn'];
    buttons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = !enable;
    });
}

// Sidebar link click handler
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to sidebar links to close sidebar on navigation
    document.querySelectorAll('.sidebar-nav a[href]').forEach(link => {
        link.addEventListener('click', function() {
            closeSidebar();
        });
    });
});

function loadResaleData() {
    // Load resellers for chat
    fetch('/api/resale/resellers')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResellers(data.resellers);
        }
    });

    // Load dashboard if user is reseller
    const username = '{{ session.get("username", "") }}';
    if ('{{ user_role }}' === 'reseller') {
        fetch(`/api/resale/dashboard/${username}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResellerDashboard(data.dashboard);
            }
        });
    }
}

function displayResellers(resellers) {
    const container = document.getElementById('resellersList');
    if (!container) return;

    container.innerHTML = resellers.map(reseller => `
        <div class="reseller-item">
            <div class="reseller-info">
                <h4>${reseller.username}</h4>
                <div class="platforms">
                    ${reseller.platforms.map(platform => 
                        `<i class="fab fa-${platform}" title="${platform}"></i>`
                    ).join('')}
                </div>
            </div>
            <button onclick="openChat('${reseller.username}')" class="btn-secondary">
                <i class="fas fa-comments"></i>
                Message
            </button>
        </div>
    `).join('');
}

function displayResellerDashboard(dashboard) {
    const statsContainer = document.getElementById('resellerStats');
    if (statsContainer) {
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${dashboard.stats.users_referred}</div>
                <div class="stat-label">Users Referred</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">$${dashboard.stats.earnings.pending.toFixed(2)}</div>
                <div class="stat-label">Pending Earnings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${dashboard.stats.commission_rate}%</div>
                <div class="stat-label">Commission Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${dashboard.stats.credits}</div>
                <div class="stat-label">Credits</div>
            </div>
        `;
    }

    const codesContainer = document.getElementById('referralCodes');
    if (codesContainer) {
        codesContainer.innerHTML = dashboard.referral_codes.map(code => `
            <div class="code-item">
                <div class="code-info">
                    <strong>${code.code}</strong>
                    <span>${code.used}/${code.limit} used</span>
                    <span>${code.tier}</span>
                </div>
                <div class="code-actions">
                    <button onclick="copyToClipboard('${code.code}')" class="btn-secondary">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                </div>
            </div>
        `).join('');
    }
}

function showResellerRequestModal() {
    showModal('resellerRequestModal');
}

function submitResellerRequest() {
    const message = document.getElementById('resellerMessage').value.trim();

    if (!message) {
        updateStatus('Please provide a message', 'error', 'exclamation-triangle');
        return;
    }

    fetch('/api/resale/request_reseller', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(data.message, 'success', 'check-circle');
            closeModal('resellerRequestModal');
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function showCreateReferralModal() {
    showModal('createReferralModal');
}

function createReferralCode() {
    const code = document.getElementById('newReferralCode').value.trim();
    const tier = document.getElementById('newReferralTier').value;
    const limit = parseInt(document.getElementById('newReferralLimit').value);
    const commissionRate = parseInt(document.getElementById('newCommissionRate').value);

    if (!code) {
        updateStatus('Please enter a referral code', 'error', 'exclamation-triangle');
        return;
    }

    fetch('/api/resale/create_referral', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            code: code,
            tier: tier,
            limit: limit,
            commission_rate: commissionRate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(data.message, 'success', 'check-circle');
            closeModal('createReferralModal');
            loadResaleData();
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function openChat(recipient) {
    currentChatRecipient = recipient;
    document.getElementById('chatModalTitle').innerHTML = `<i class="fas fa-comments"></i> Chat with ${recipient}`;
    loadChatMessages(recipient);
    showModal('chatModal');
}

function loadChatMessages(recipient) {
    fetch(`/api/resale/chat/get/${recipient}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayChatMessages(data.messages);
        }
    });
}

function displayChatMessages(messages) {
    const container = document.getElementById('chatMessages');
    const currentUser = '{{ session.get("username", "") }}';

    container.innerHTML = messages.map(msg => `
        <div class="chat-message ${msg.sender === currentUser ? 'own' : 'other'}">
            <div class="message-bubble ${msg.sender === currentUser ? 'own' : 'other'}">
                ${msg.message}
                <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            </div>
        </div>
    `).join('');

    container.scrollTop = container.scrollHeight;
}

function handleChatKeypress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function sendChatMessage() {
    const input = document.getElementById('chatMessageInput');
    const message = input.value.trim();

    if (!message) return;

    fetch('/api/resale/chat/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            recipient: currentChatRecipient,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadChatMessages(currentChatRecipient);
        }
    });
}

// Settings functions
function applySettings() {
    const settings = {
        theme: document.getElementById('themeSelect').value,
        fontSize: document.getElementById('fontSizeSelect').value,
    };

    localStorage.setItem('userSettings', JSON.stringify(settings));
    applyTheme(settings.theme);
    updateStatus('Settings applied successfully!', 'success', 'check-circle');
}

function resetSettings() {
    customConfirm('Reset Settings', 'Reset all settings to default?', (confirmed) => {
        if (confirmed) {
            localStorage.removeItem('userSettings');
            location.reload();
        }
    });
}

function exportSettings() {
    const settings = localStorage.getItem('userSettings') || '{}';
    const blob = new Blob([settings], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'firebase-editor-settings.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importSettings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const settings = JSON.parse(e.target.result);
                    localStorage.setItem('userSettings', JSON.stringify(settings));
                    location.reload();
                } catch (error) {
                    updateStatus('Invalid settings file', 'error', 'exclamation-triangle');
                }
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

function loadNotifications() {
    fetch('/api/notifications')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayNotifications(data.notifications);
        }
    });
}

function displayNotifications(notifications) {
    const container = document.getElementById('notificationsList');
    if (!container) return;

    container.innerHTML = notifications.map(notif => `
        <div class="notification-item ${notif.is_read ? '' : 'unread'}">
            <div class="notification-header">
                <span>${notif.title}</span>
                <span class="notification-time">${new Date(notif.timestamp).toLocaleTimeString()}</span>
            </div>
            <div class="notification-content">
                ${notif.message}
            </div>
        </div>
    `).join('');
}

// Custom Dialog Functions
let dialogCallback = null;

function customAlert(title, message) {
    document.getElementById('alertTitle').textContent = title;
    document.getElementById('alertMessage').textContent = message;
    showModal('customAlert');
}

function customConfirm(title, message, callback) {
    document.getElementById('dialogTitle').textContent = title;
    document.getElementById('dialogMessage').textContent = message;
    dialogCallback = callback;
    showModal('customDialog');
}

function handleDialogConfirm() {
    if (dialogCallback) {
        dialogCallback(true);
        dialogCallback = null;
    }
    closeModal('customDialog');
}

function showNotifications() {
    loadNotifications();
    showModal('notificationsModal');
    closeSidebar();
}

function showMessages() {
    loadMessages();
    showModal('messagesModal');
    closeSidebar();
}

function loadNotifications() {
    fetch('/api/notifications')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayNotifications(data.notifications);
            updateNotificationDot(data.unread_count);
        }
    });
}

function loadMessages() {
    fetch('/api/messages')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessages(data.conversations);
            updateMessagesDot(data.unread_count);
        }
    });
}

function displayNotifications(notifications) {
    const container = document.getElementById('notificationsList');
    if (!container) return;

    if (notifications.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--fg-secondary); padding: 20px;">No notifications</div>';
        return;
    }

    container.innerHTML = notifications.map(notif => `
        <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markNotificationRead('${notif.id}')">
            <div class="notification-header">
                <span class="notification-title">${notif.title}</span>
                <span class="notification-time">${new Date(notif.timestamp).toLocaleString()}</span>
            </div>
            <div class="notification-content">
                ${notif.message}
            </div>
        </div>
    `).join('');
}

function displayMessages(conversations) {
    const container = document.getElementById('messagesList');
    if (!container) return;

    if (conversations.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--fg-secondary); padding: 20px;">No messages</div>';
        return;
    }

    container.innerHTML = conversations.map(conv => `
        <div class="message-item ${conv.unread_count > 0 ? 'unread' : ''}" onclick="openIndividualChat('${conv.participant}')">
            <div class="message-header">
                <span class="message-sender">${conv.participant}</span>
                <span class="notification-time">${new Date(conv.last_message_time).toLocaleString()}</span>
            </div>
            <div class="message-preview">
                ${conv.last_message}
                ${conv.unread_count > 0 ? `<span style="color: var(--accent-tertiary); font-weight: 600;"> (${conv.unread_count} new)</span>` : ''}
            </div>
        </div>
    `).join('');
}

function markNotificationRead(notificationId) {
    fetch('/api/notifications/read', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({notification_id: notificationId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadNotifications();
        }
    });
}

function markAllNotificationsRead() {
    fetch('/api/notifications/mark_all_read', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadNotifications();
        }
    });
}

function clearAllNotifications() {
    customConfirm('Clear Notifications', 'Are you sure you want to clear all notifications?', (confirmed) => {
        if (confirmed) {
            fetch('/api/notifications/clear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotifications();
                }
            });
        }
    });
}

function openIndividualChat(participant) {
    currentChatRecipient = participant;
    document.getElementById('individualChatTitle').innerHTML = `<i class="fas fa-comments"></i> Chat with ${participant}`;
    loadIndividualChatMessages(participant);
    closeModal('messagesModal');
    showModal('individualChatModal');
}

function loadIndividualChatMessages(participant) {
    fetch(`/api/resale/chat/get/${participant}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayIndividualChatMessages(data.messages);
        }
    });
}

function displayIndividualChatMessages(messages) {
    const container = document.getElementById('individualChatMessages');
    const currentUser = '{{ session.get("username", "") }}';

    container.innerHTML = messages.map(msg => `
        <div class="chat-message ${msg.sender === currentUser ? 'own' : 'other'}">
            <div class="message-bubble ${msg.sender === currentUser ? 'own' : 'other'}">
                ${msg.message}
                <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            </div>
        </div>
    `).join('');

    container.scrollTop = container.scrollHeight;
}

function handleIndividualChatKeypress(event) {
    if (event.key === 'Enter') {
        sendIndividualChatMessage();
    }
}

function sendIndividualChatMessage() {
    const input = document.getElementById('individualChatInput');
    const message = input.value.trim();

    if (!message) return;

    fetch('/api/resale/chat/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            recipient: currentChatRecipient,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadIndividualChatMessages(currentChatRecipient);
            loadMessages(); // Refresh messages list
        }
    });
}

function updateNotificationDot(unreadCount) {
    const dot = document.getElementById('notificationDot');
    if (dot) {
        dot.style.display = unreadCount > 0 ? 'block' : 'none';
    }
}

function updateMessagesDot(unreadCount) {
    const dot = document.getElementById('messagesDot');
    if (dot) {
        dot.style.display = unreadCount > 0 ? 'block' : 'none';
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    renderTree(currentData);
    loadResaleData();
    loadNotifications();

    // Load saved settings
    const savedSettings = localStorage.getItem('userSettings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        // Apply saved settings to form elements
        Object.keys(settings).forEach(key => {
            const element = document.getElementById(key + 'Select') || document.getElementById(key);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = settings[key];
                } else {
                    element.value = settings[key];
                }
            }
        });
        applyTheme(settings.theme || 'default');
    }

    // Load notifications and messages status initially
    loadNotifications();
    loadMessages();

    // Periodic notification and messages check
    setInterval(() => {
        loadNotifications();
        loadMessages();
    }, 30000); // Check every 30 seconds
});

// Keep all other existing functions (fetchData, updateNode, etc.)...
// Sidebar Functions
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const content = document.querySelector('.content-wrapper');

    if (sidebar.classList.contains('open')) {
        closeSidebar();
    } else {
        sidebar.classList.add('open');
        overlay.classList.add('show');
        if (window.innerWidth > 1200) {
            content.classList.add('shifted');
        }
    }
}

function closeSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const content = document.querySelector('.content-wrapper');

    sidebar.classList.remove('open');
    overlay.classList.remove('show');
    content.classList.remove('shifted');
}

// Theme System
function initThemeSystem() {
    const themeOptions = document.querySelectorAll('.theme-option');
    const themeSelect = document.getElementById('themeSelect');

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'default';
    applyTheme(savedTheme);

    themeOptions.forEach(option => {
        option.addEventListener('click', () => {
            const theme = option.dataset.theme;
            applyTheme(theme);
            localStorage.setItem('theme', theme);
        });
    });

    if (themeSelect) {
        themeSelect.value = savedTheme;
        themeSelect.addEventListener('change', (e) => {
            const theme = e.target.value;
            applyTheme(theme);
            localStorage.setItem('theme', theme);
        });
    }
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);

    document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
    });

    document.querySelector(`[data-theme="${theme}"]`).classList.add('active');

    const themeSelect = document.getElementById('themeSelect');
    if (themeSelect) {
        themeSelect.value = theme;
    }
}

// Path Navigation
function handlePathNavigation(event) {
    if (event.key === 'Enter') {
        navigateToPath();
    }
}

function navigateToPath() {
    const path = document.getElementById('pathNavigator').value.trim();
    if (!path) return;

    // Navigate to the specified path in the tree
    selectNodeByPath(path);
    updateStatus(`Navigated to /${path}`, 'success', 'map-marker-alt');
}

function selectNodeByPath(targetPath) {
    // Expand all necessary parent nodes
    const pathParts = targetPath.split('/');
    let currentPath = '';

    for (let i = 0; i < pathParts.length - 1; i++) {
        if (currentPath) currentPath += '/';
        currentPath += pathParts[i];
        expandedNodes.add(currentPath);
    }

    // Re-render tree with expanded nodes
    renderTree(currentData);

    // Select the target node
    selectNode(targetPath, pathParts[pathParts.length - 1]);

    // Scroll to the selected node
    setTimeout(() => {
        const selectedNode = document.querySelector('.tree-node.selected');
        if (selectedNode) {
            selectedNode.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
    }, 100);
}

// Admin Panel Functions
function switchResaleTab(tab) {
    const tabs = document.querySelectorAll('.resale-tab');
    const contents = document.querySelectorAll('.resale-content');

    tabs.forEach(t => t.classList.remove('active'));
    contents.forEach(c => c.classList.remove('active'));

    document.querySelector(`[onclick="switchResaleTab('${tab}')"]`).classList.add('active');
    document.getElementById('resale-' + tab).classList.add('active');
}

// Keep all existing functions (fetchData, updateNode, etc.) and add new ones...

function fetchData() {
    const url = document.getElementById('firebaseUrl').value.trim();
    if (!url) {
        updateStatus('Please enter a Firebase URL', 'error', 'exclamation-triangle');
        return;
    }

    const fetchBtn = document.getElementById('fetchBtn');
    setLoading(fetchBtn, true);
    updateStatus('Fetching data from Firebase...', 'info', 'spinner fa-spin');

    fetch('/api/fetch_data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentData = data.tree_data;
            renderTree(currentData);
            updateStatus(data.message, 'success', 'check-circle');
            document.getElementById('applyBtn').disabled = false;
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    })
    .catch(error => {
        updateStatus('Network error occurred', 'error', 'wifi');
    })
    .finally(() => {
        setLoading(fetchBtn, false);
    });
}

function updateNode() {
    const value = document.getElementById('nodeValue').value;

    fetch('/api/update_node', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({path: selectedPath, value: value})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentData = data.tree_data;
            renderTree(currentData);
            updateStatus(data.message, 'success', 'check-circle');
            document.getElementById('applyBtn').disabled = false;
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

// Keep all other existing functions...
function deleteNode() {
    customConfirm('Confirm Delete', `Are you sure you want to delete /${selectedPath}?`, (confirmed) => {
        if (confirmed) {
            fetch('/api/delete_node', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: selectedPath})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentData = data.tree_data;
                    renderTree(currentData);
                    updateStatus(data.message, 'success', 'check-circle');
                    document.getElementById('selectedPath').innerHTML = '';
                    document.getElementById('nodeValue').value = '';
                    enableNodeActions(false);
                    document.getElementById('applyBtn').disabled = false;
                } else {
                    updateStatus(data.error, 'error', 'exclamation-triangle');
                }
            });
        }
    });
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto';
}

function showAddChildModal() {
    document.getElementById('childKey').value = '';
    document.getElementById('childValue').value = '';
    showModal('addChildModal');
}

function addChild() {
    const key = document.getElementById('childKey').value.trim();
    const value = document.getElementById('childValue').value.trim();

    fetch('/api/add_child', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({path: selectedPath, key: key, value: value})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentData = data.tree_data;
            renderTree(currentData);
            updateStatus(data.message, 'success', 'check-circle');
            closeModal('addChildModal');
            document.getElementById('applyBtn').disabled = false;
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function showDuplicateModal() {
    document.getElementById('duplicateKey').value = '';
    showModal('duplicateModal');
}

function duplicateNode() {
    const newKey = document.getElementById('duplicateKey').value.trim();

    fetch('/api/duplicate_node', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({path: selectedPath, new_key: newKey})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentData = data.tree_data;
            renderTree(currentData);
            updateStatus(data.message, 'success', 'check-circle');
            closeModal('duplicateModal');
            document.getElementById('applyBtn').disabled = false;
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function showPushItemModal() {
    document.getElementById('pushContent').value = '';
    showModal('pushItemModal');
}

function pushItem() {
    const content = document.getElementById('pushContent').value.trim();
    const url = document.getElementById('firebaseUrl').value.trim();

    fetch('/api/push_item', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url, path: selectedPath, content: content})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(data.message, 'success', 'check-circle');
            closeModal('pushItemModal');
            fetchData();
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function applyChanges() {
    const url = document.getElementById('firebaseUrl').value.trim();
    customConfirm('Apply Changes', 'Apply local changes to Firebase? This will overwrite corresponding data on the server.', (confirmed) => {
        if (confirmed) {
            updateStatus('Applying changes to Firebase...', 'info', 'cloud-upload-alt');

            fetch('/api/apply_changes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus(data.message, 'success', 'check-circle');
                    document.getElementById('applyBtn').disabled = true;
                } else {
                    updateStatus(data.error, 'error', 'exclamation-triangle');
                }
            });
        }
    });
}

function searchData() {
    const term = document.getElementById('searchTerm').value.trim();
    if (!term) {
        updateStatus('Please enter a search term', 'error', 'search');
        return;
    }

    fetch('/api/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({term: term})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            searchResults = data.results;
            currentSearchIndex = 0;
            highlightSearchResult();
            updateStatus(data.message, 'success', 'search');
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function highlightSearchResult() {
    if (searchResults.length === 0) return;

    const result = searchResults[currentSearchIndex];
    selectNode(result.path, result.key);

    const selectedNode = document.querySelector('.tree-node.selected');
    if (selectedNode) {
        selectedNode.scrollIntoView({behavior: 'smooth', block: 'center'});
    }
}

function showAddUrlModal() {
    document.getElementById('urlName').value = '';
    document.getElementById('urlValue').value = document.getElementById('firebaseUrl').value;
    showModal('addUrlModal');
}

function addUrlProfile() {
    const name = document.getElementById('urlName').value.trim();
    const url = document.getElementById('urlValue').value.trim();

    fetch('/api/url_profiles', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name, url: url})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(data.message, 'success', 'check-circle');
            closeModal('addUrlModal');
            location.reload();
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function removeUrlProfile() {
    const select = document.getElementById('urlProfile');
    const name = select.value;
    if (!name) {
        updateStatus('No profile selected', 'error', 'exclamation-triangle');
        return;
    }

    customConfirm('Confirm Delete', `Remove URL profile "${name}"?`, (confirmed) => {
        if (confirmed) {
             fetch('/api/url_profiles', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus(data.message, 'success', 'check-circle');
                    location.reload();
                } else {
                    updateStatus(data.error, 'error', 'exclamation-triangle');
                }
            });
        }
    });
}

function saveData() {
    window.open('/api/save_data', '_blank');
}

function loadDataFromFile() {
    document.getElementById('fileInput').click();
}

function handleFileLoad(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            updateStatus('File loaded successfully', 'success', 'check-circle');
        } catch (error) {
            updateStatus('Invalid JSON file', 'error', 'exclamation-triangle');
        }
    };
    reader.readAsText(file);
}

function exportData() {
    showModal('exportModal');
}

function performExport() {
    const format = document.getElementById('exportFormat').value;

    fetch('/api/export_data', {        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({format: format})
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `firebase_data.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        closeModal('exportModal');
        updateStatus('Data exported successfully', 'success', 'download');
    })
    .catch(error => {
        updateStatus('Export failed', 'error', 'exclamation-triangle');
    });
}

function loadSchema() {
    document.getElementById('schemaInput').click();
}

function handleSchemaLoad(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('schema_file', file);

    fetch('/api/load_schema', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(data.message, 'success', 'check-circle');
            location.reload();
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
        }
    });
}

function validateSchema() {
    fetch('/api/validate_schema', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(data.message, 'success', 'check-circle');
            customAlert('Validation Result', ' ' + data.message);
        } else {
            updateStatus(data.error, 'error', 'exclamation-triangle');
            customAlert('Validation Result', ' ' + data.error);
        }
    });
}

function logout() {
    customConfirm('Confirm Logout', 'Are you sure you want to logout?', (confirmed) => {
        if (confirmed) {
            window.location.href = '/logout';
        }
    });
}

function setLoading(element, loading) {
    if (loading) {
        element.classList.add('loading');
        element.disabled = true;
    } else {
        element.classList.remove('loading');
        element.disabled = false;
    }
}

function updateStatus(message, type = 'info', icon = 'info-circle') {
    const status = document.getElementById('status');
    status.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
    status.className = `status ${type}`;

    status.style.animation = 'none';
    status.offsetHeight;
    status.style.animation = 'slideIn 0.5s ease';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme system
    initThemeSystem();

    const urlProfile = document.getElementById('urlProfile');
    if (urlProfile) {
        urlProfile.addEventListener('change', function() {
            const profileName = this.value;
            if (profileName) {
                fetch('/api/url_profiles')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.profiles[profileName]) {
                        document.getElementById('firebaseUrl').value = data.profiles[profileName];
                    }
                });
            }
        });
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey || event.metaKey) {
            switch(event.key) {
                case 'k':
                    event.preventDefault();
                    document.getElementById('searchTerm').focus();
                    break;
                case 's':
                    event.preventDefault();
                    if (currentView === 'app' && selectedPath) {
                        updateNode();
                    }
                    break;
                case '\\':
                    event.preventDefault();
                    toggleSidebar();
                    break;
            }
        }

        if (event.key === 'Escape') {
            closeSidebar();
        }
    });
});

</script>
{% endblock %}