
{% extends "base.html" %}

{% block title %}Profile - Firebase RTDB Editor{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-header">
        <h2>
            <i class="fas fa-user-circle"></i>
            User Profile
        </h2>
        <button onclick="goBack()" class="btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Firebase Editor
        </button>
    </div>

    <div class="profile-content">
        <div class="profile-card">
            <div class="profile-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="profile-info">
                <h3 id="profileUsername">{{ session.get('username', 'Demo User') }}</h3>
                <p id="profileTier">{{ tier }}</p>
            </div>
        </div>

        <div class="profile-details">
            <div class="detail-section">
                <h4>Account Information</h4>
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="username" value="{{ session.get('username', 'demo_user') }}" readonly>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" placeholder="Enter your email...">
                </div>
                <div class="form-group">
                    <label>Subscription Tier:</label>
                    <input type="text" id="tier" value="{{ tier }}" readonly>
                </div>
                <div class="form-group">
                    <label>Member Since:</label>
                    <input type="text" id="memberSince" value="January 2024" readonly>
                </div>
            </div>

            <div class="detail-section">
                <h4>Security</h4>
                <div class="form-group">
                    <label>Current Password:</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password...">
                </div>
                <div class="form-group">
                    <label>New Password:</label>
                    <input type="password" id="newPassword" placeholder="Enter new password...">
                </div>
                <div class="form-group">
                    <label>Confirm New Password:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password...">
                </div>
            </div>

            <div class="detail-section">
                <h4>API Access</h4>
                <div class="form-group">
                    <label>API Key:</label>
                    <div class="api-key-container">
                        <input type="text" id="apiKey" value="fdb_{{ session.get('username', 'demo') }}_demo_key" readonly>
                        <button onclick="regenerateApiKey()" class="btn-secondary">
                            <i class="fas fa-refresh"></i>
                            Regenerate
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>API Usage:</label>
                    <div class="usage-stats">
                        <div class="usage-item">
                            <span>Requests Today:</span>
                            <span>245 / 1000</span>
                        </div>
                        <div class="usage-item">
                            <span>Requests This Month:</span>
                            <span>5,680 / 50,000</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h4>Subscription Details</h4>
                <div class="subscription-info">
                    <div class="sub-item">
                        <span>Current Plan:</span>
                        <span class="plan-name">{{ tier }}</span>
                    </div>
                    <div class="sub-item">
                        <span>Status:</span>
                        <span class="status-active">Active</span>
                    </div>
                    <div class="sub-item">
                        <span>Next Billing:</span>
                        <span>February 15, 2024</span>
                    </div>
                    <div class="sub-item">
                        <span>Billing Method:</span>
                        <span>Credit Card (**** 1234)</span>
                    </div>
                </div>
                {% if tier != 'Elite Edition' %}
                <button onclick="showUpgradeModal()" class="upgrade-btn">
                    <i class="fas fa-arrow-up"></i>
                    Upgrade Plan
                </button>
                {% endif %}
            </div>

            <div class="detail-section">
                <h4>Account Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">127</div>
                        <div class="stat-label">Databases Connected</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">1,245</div>
                        <div class="stat-label">Operations Performed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">34</div>
                        <div class="stat-label">Days Active</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">98.5%</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                </div>
            </div>

            <div class="profile-actions">
                <button onclick="saveProfile()" class="save-btn">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
                <button onclick="exportProfile()" class="btn-secondary">
                    <i class="fas fa-download"></i>
                    Export Profile
                </button>
                <button onclick="deleteAccount()" class="btn-danger">
                    <i class="fas fa-trash"></i>
                    Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upgrade Modal -->
<div id="upgradeModal" class="modal">
    <div class="modal-content">
        <h3>
            <i class="fas fa-arrow-up"></i>
            Upgrade Your Plan
        </h3>
        <div class="upgrade-options">
            {% if tier == 'Silver Edition' %}
            <div class="upgrade-option">
                <h4>Gold Edition</h4>
                <div class="upgrade-price">$9.99/month</div>
                <ul>
                    <li>Edit Access</li>
                    <li>Export Data</li>
                    <li>Advanced Features</li>
                </ul>
                <button onclick="upgradePlan('Gold Edition')" class="upgrade-plan-btn">
                    <i class="fas fa-credit-card"></i>
                    Upgrade to Gold
                </button>
            </div>
            <div class="upgrade-option">
                <h4>Elite Edition</h4>
                <div class="upgrade-price">$19.99/month</div>
                <ul>
                    <li>Full Access</li>
                    <li>Admin Panel</li>
                    <li>API Access</li>
                    <li>Priority Support</li>
                </ul>
                <button onclick="upgradePlan('Elite Edition')" class="upgrade-plan-btn">
                    <i class="fas fa-crown"></i>
                    Upgrade to Elite
                </button>
            </div>
            {% elif tier == 'Gold Edition' %}
            <div class="upgrade-option">
                <h4>Elite Edition</h4>
                <div class="upgrade-price">$19.99/month</div>
                <ul>
                    <li>Full Access</li>
                    <li>Admin Panel</li>
                    <li>API Access</li>
                    <li>Priority Support</li>
                </ul>
                <button onclick="upgradePlan('Elite Edition')" class="upgrade-plan-btn">
                    <i class="fas fa-crown"></i>
                    Upgrade to Elite
                </button>
            </div>
            {% endif %}
        </div>
        <div class="modal-actions">
            <button onclick="closeModal('upgradeModal')" class="btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<style>
/* Profile Styles */
.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.profile-header h2 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.profile-content {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 32px;
}

.profile-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 32px;
    text-align: center;
    box-shadow: var(--shadow-card);
    height: fit-content;
}

.profile-avatar {
    font-size: 80px;
    color: var(--accent-primary);
    margin-bottom: 20px;
}

.profile-info h3 {
    font-family: 'JetBrains Mono', monospace;
    color: var(--fg-primary);
    margin-bottom: 8px;
    font-size: 24px;
}

.profile-info p {
    color: var(--accent-secondary);
    font-weight: 600;
    background: var(--bg-secondary);
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-block;
}

.profile-details {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 32px;
    box-shadow: var(--shadow-card);
}

.detail-section {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-primary);
}

.detail-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.detail-section h4 {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-primary);
    margin-bottom: 20px;
    font-size: 18px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
    color: var(--fg-secondary);
    margin-bottom: 8px;
    font-size: 14px;
}

.form-group input {
    width: 100%;
}

.api-key-container {
    display: flex;
    gap: 12px;
}

.api-key-container input {
    flex: 1;
}

.usage-stats {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 16px;
}

.usage-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
}

.usage-item:last-child {
    margin-bottom: 0;
}

.subscription-info {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
}

.sub-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
}

.sub-item:last-child {
    margin-bottom: 0;
}

.plan-name {
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 600;
}

.status-active {
    color: var(--accent-primary);
    font-weight: 600;
}

.upgrade-btn {
    background: var(--gradient-secondary);
    color: var(--bg-primary);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.upgrade-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 20px rgba(255, 170, 0, 0.4);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
}

.stat-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: var(--accent-primary);
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 8px;
}

.stat-label {
    color: var(--fg-secondary);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.profile-actions {
    display: flex;
    gap: 16px;
    margin-top: 32px;
    justify-content: center;
}

.save-btn {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border: none;
    padding: 16px 32px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.save-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-neon);
}

.upgrade-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.upgrade-option {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
}

.upgrade-option h4 {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-primary);
    margin-bottom: 12px;
}

.upgrade-price {
    font-size: 24px;
    font-weight: 600;
    color: var(--accent-secondary);
    margin-bottom: 16px;
}

.upgrade-option ul {
    list-style: none;
    padding: 0;
    margin-bottom: 20px;
}

.upgrade-option li {
    padding: 4px 0;
    color: var(--fg-secondary);
}

.upgrade-plan-btn {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 auto;
}

.upgrade-plan-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-neon);
}

@media (max-width: 768px) {
    .profile-content {
        grid-template-columns: 1fr;
        gap: 24px;
    }

    .profile-actions {
        flex-direction: column;
    }

    .api-key-container {
        flex-direction: column;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .upgrade-options {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Profile Functions
function loadProfile() {
    fetch('/api/profile')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const profile = data.profile;
            document.getElementById('email').value = profile.email || '';
            document.getElementById('apiKey').value = profile.api_key || 'fdb_demo_key';
        }
    });
}

function saveProfile() {
    const email = document.getElementById('email').value.trim();
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword && newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
    }

    if (newPassword && !currentPassword) {
        alert('Current password is required to change password');
        return;
    }

    const updateData = {
        email: email
    };

    if (newPassword) {
        updateData.password = newPassword;
        updateData.current_password = currentPassword;
    }

    fetch('/api/profile', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Profile updated successfully!');
            // Clear password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        } else {
            alert(data.error || 'Failed to update profile');
        }
    });
}

function regenerateApiKey() {
    if (confirm('Are you sure you want to regenerate your API key? The old key will stop working immediately.')) {
        fetch('/api/profile/regenerate_key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('apiKey').value = data.new_key;
                alert('API key regenerated successfully!');
            } else {
                alert('Failed to regenerate API key');
            }
        });
    }
}

function exportProfile() {
    const profileData = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        tier: document.getElementById('tier').value,
        api_key: document.getElementById('apiKey').value,
        export_date: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(profileData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'profile_export.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('Profile exported successfully!');
}

function deleteAccount() {
    const confirmation = prompt('This action cannot be undone. Type "DELETE" to confirm account deletion:');
    
    if (confirmation === 'DELETE') {
        if (confirm('Are you absolutely sure? This will permanently delete your account and all associated data.')) {
            fetch('/api/profile/delete', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Account deleted successfully. You will be logged out.');
                    window.location.href = '/logout';
                } else {
                    alert('Failed to delete account: ' + data.error);
                }
            });
        }
    } else if (confirmation !== null) {
        alert('Account deletion cancelled. You must type "DELETE" exactly.');
    }
}

function showUpgradeModal() {
    showModal('upgradeModal');
}

function upgradePlan(plan) {
    if (confirm(`Upgrade to ${plan}? You will be charged according to the new plan pricing.`)) {
        fetch('/api/profile/upgrade', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({plan: plan})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully upgraded to ${plan}! Please log in again to access new features.`);
                window.location.href = '/logout';
            } else {
                alert('Upgrade failed: ' + data.error);
            }
        });
    }
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto';
}

function goBack() {
    window.location.href = '/';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
});
</script>
{% endblock %}
